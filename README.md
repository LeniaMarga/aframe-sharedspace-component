# aframe-sharedspace-component
> A-Frame VR component to create multi-user experiences with WebRTC

Try the

## HTTPS
WebRTC works with secure origins only, so your site must be served from `localhost` or HTTPS for the component to work. If you need to access your application from the Internet, use [ngrok](https://ngrok.com/) or build it completely on [glitch](https://glitch.com/). Both options work great.

## Install
You will need `node` and `npm` installed in your system. Once installed, simply run the following command from the root of your project to install as a dependency:

```bash
$ npm install --save aframe-sharedspace-component
```

Or add the script tag to the component after including A-Frame:

```html
<script src="https://cdn.rawgit.com/delapuente/aframe-sharedspace-component/master/dist/aframe-sharedspace-component.js"></script>
```

## Minimal setup

Once A-Frame and the `sharedspace` component are [installed](#install), this is all the HTML you need to create a chatroom (really!):

```html
<a-scene>
  <a-entity sharedspace="audio: true" participants>
  </a-entity>
</a-scene>
<template>
  <a-sphere radius="0.1" position-around><a-sphere>
</template>
```

Unfortunately, the chatroom lacks from decoration and participants will be spheres, which is not the best way of representing a human head. Instead, take a look at the [Minimal Chatroom application on Glitch](glitch.com/edit/#!/minimal-chatroom) for a **functional** minimal setup.

## Component overview

When installing `sharedspace`, four components are registered with A-Frame:

| Component         | Description                                          |
|-------------------|------------------------------------------------------|
| `sharedspace`     | Provides the participation model.                    |
| `participants`    | Represent participants as A-Frame entities.          |
| `share`           | Controls the state of the participant to share.      |
| `position-around` | Helper to position an entity around a central point. |

### sharedspace

This component provides the participation model: a named room with participants entering and leaving. Participants can send arbitrary data to other participants or share audio with all of them. We refer to the participant representing the user as the _local participant_, while other people in the room are _remote participants_, _peers_ or simply, _participants_.

#### Properties

| Property   | Description                                     | Default |
|------------|-------------------------------------------------|---------|
| `hold`     | If set, prevents the component from connecting. | `false` |
| `provider` | URL to the signaling server. | `https://salvadelapuente.com:9000` |
| `room`     | Room name. | [`room-101`](http://matrix.wikia.com/wiki/Room_101) |
| `audio`    | If set, will ask for user media.                | `false` |
| `me`       | User unique id. Randomly generated by default.  | `''`    |

Set the `hold` property to `true` to prevent the component from joining the room. While holding, configure the component and connect by setting `hold` to `false`. Notice that changing the properties once the `sharedspace` component has connected has no effect.

Use this technique to generate room links and share them with your friends, or to join specific rooms. Consider the following snippet as reference:

```html
<a-scene>
  <a-entity sharedspace="hold: true">
    <!-- Your room -->
  </a-entity>
<a-scene>

<script>
  var room = document.querySelector('[sharedspace]');
  var roomName = window.location.search.substr(1);
  if (!roomName) {
    roomName = Date.now() + '';
    history.pushState({}, '', window.location + '?' + roomName);
  }
  connect();

  function connect() {
    var scene = document.querySelector('a-scene');
    if (!scene.hasLoaded) {
      scene.addEventListener('loaded', connect);
      return;
    }
    room.setAttribute('sharedspace', { room: roomName, hold: false });
  }
</script>
```

#### Methods

##### `isConnected()`

Returns `true` if the local participant has connected to the **signaling server**. It does not guarantee that the local participant can to join the room.

You can consider the component effectively connected after receiving your `enterparticipant` event (i.e. that with the `isMe` property set to `true`).

```js
// <a-entity sharedspace></a-entity>
var room = document.querySelector('[sharedspace]');
room.components.sharedspace.isConnected();
```

##### `send(target, message)`

Send a [JSON-serializable](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify) `message` to the participant with `target` id. Use `*` as `target` to broadcast the message to all remote participants.

```js
// <a-entity sharedspace></a-entity>
var room = document.querySelector('[sharedspace]');
room.components.send('*', { myName: 'Salva' });
```

#### Events

| Name                 | Description                                       |
|----------------------|---------------------------------------------------|
| `enterparticipant`   | The local or a remote participant joins the room. |
| `exitparticipant`    | A remote participant exits the room.              |
| `participantstream`  | A remote participant shares audio.                |
| `participantmessage` | A remote participant sends a message.             |

Events `participantstream` and `participantmessage` for a participant are guaranteed to be received after the `enterparticipant` event of the same participant. Otherwise is a [bug](https://github.com/delapuente/aframe-sharedspace-component/issues).

All the events are emitted in the component's element:

```js
// <a-entity sharedspace></a-entity>
var room = document.querySelector('[sharedspace]');
room.addEventListener('enterparticipant', function (evt) {
  var detail = evt.detail;
  console.log(detail.id + 'entered with position ' + detail.position);
});
```

##### Detail

| Name                 | Detail     | Description                           |
|----------------------|----------------------------------------------------|
| `enterparticipant`   | `id`       | Participant unique id.                |
|                      | `position` | Order in the room.                    |
|                      | `isMe`     | `true` if it's the local participant. |
| `exitparticipant`    | `id`       | Participant unique id.                |
|                      | `position` | Order in the room.                    |
|                      | `isMe`     | `true` if it's the local participant. |
| `participantstream`  | `id`       | Participant unique id.                |
|                      | `stream`   | [MediaStream](https://developer.mozilla.org/en-US/docs/Web/API/MediaStream) object                    |
| `participantmessage` | `id`       | Participant unique id.                |
|                      | `message`  | Message                    |

### participants

The `sharedspace` component is useless when used in isolation, but provides the necessary hooks for creating multi-user experiences. To use `sharedspace` in an effective way, your application should listen to the aforementioned events and translate them into changes in the A-Frame scene. The `participants` component does this in a configurable and powerful way.

## Develop
Issuing the following command will run a local server with live-reload listening at port `8080` and a local WebRTC signaling server at port `9000`:

```bash
$ npm start
```

You need to point the `sharedspace` component to the developer server. Use the `provider` property to that end:

```html
<a-entity sharedspace="provider: http://localhost:9000">
  <!-- Here is the content of your shared space -->
</a-entity>
```

## Build
If you want to generate the JavaScript bundle for the library, run the following command and the package will be under the `dist` folder:

```bash
$ npm run build
```

### Size analysis
You can set the `SIZE_ANALYSIS` environment variable to visualize the size of the bundle components.

```bash
$ SIZE_ANALYSIS=1 npm run build
```

## Deploy
Finally, if you want to publish "The (Un)Happy Birthday Chamber" demo on GitHub Pages, run:

```bash
$ npm run deploy
```
